{% extends 'index.html' %}
{% load static %}
{% load tz %}
{% block content %}
<h1>Pagos de {{ usuario.nombres }} {{ usuario.apellido_paterno }}</h1>
<table class="table table-striped">
  <thead>
    <tr>
      <th>Año</th>
      <th>Mes</th>
      <th>Consumo m³</th>
      <th>Monto</th>
      <th>Estado</th>
      <th>Fecha de pago</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for item in lecturas %}
    <tr>
      <td>{{ item.anio }}</td>
      <td>{{ item.mes }}</td>
      <td>{{ item.consumo }}</td>
      <td>{{ item.monto|floatformat:2 }}</td>
      <td>
        {% if item.pagado %}
          <span class="badge bg-success">Pagado</span>
        {% else %}
          <span class="badge bg-danger">Pendiente</span>
        {% endif %}
      </td>
      <td>{{ item.fecha_pago|default:"—" }}</td>
      <<td>
        {% if item.foto_url %}
          <a href="{{ item.foto_url }}" target="_blank" class="btn btn-outline-secondary btn-sm" title="Ver foto">
            <i class="ti ti-eye"></i>  {# o cualquier icono de ojo que uses #}
          </a>
        {% endif %}

        {% if not item.pagado %}
          <a href="{% url 'registrar_pago' usuario.id item.anio item.mes %}"
            class="btn btn-primary btn-sm">
            Pagar
          </a>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="mb-3 no-print">
  <button type="button" class="btn btn-secondary" onclick="window.print()">
    Imprimir recibo
  </button>
</div>

<!-- CONTENEDOR SOLO PARA IMPRESIÓN (MEDIA A4) -->
{% load qr_code %}
<div id="recibo" class="receipt-page">

  <div class="receipt-header">
    <div class="header-left">
      <img src="{% static 'images/logo.png' %}" alt="Logo JAAP" class="logo-recibo">
      <p><strong>Tarifa vigente:</strong> {{ tarifa }} por m³</p>
    </div>

    <div class="header-center">
      <h3>RECIBO DE COBRO</h3>
      <p><strong>Usuario:</strong> {{ usuario.nombres }} {{ usuario.apellido_paterno }}</p>
      <p><strong>Sector:</strong> {{ sector.nombre }}</p>
      <p><strong>Fecha emisión:</strong> {% now "d/m/Y" %}</p>
      <p><strong>Cédula/DNI:</strong> {{ usuario.dni_cedula }}</p>
      
    </div>

    <div class="header-right">
      {% qr_from_text usuario.dni_cedula size="S" image_format="png" %}
    </div>
  </div>

  <div class="receipt-body">
    <div class="receipt-layout">
      <div class="receipt-table-wrapper">
        <table class="table table-sm table-recibo">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Consumo m³</th>
              <th>Monto</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody>
            {% if lectura_recibo %}
            <tr>
              <td>{{ lectura_recibo.mes }}/{{ lectura_recibo.anio }}</td>
              <td>{{ lectura_recibo.consumo }}</td>
              <td>{{ lectura_recibo.monto|floatformat:2 }}</td>
              <td>{% if lectura_recibo.pagado %}Pagado{% else %}Pendiente{% endif %}</td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4">No hay lecturas para mostrar.</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="chart-container">
        <canvas id="consumoChart"></canvas>
      </div>
    </div>
  </div>
</div>



{% if messages %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    {% for message in messages %}
    iziToast.success({
      title: '{{ message.tags|title }}',
      message: '{{ message }}',
      position: 'topRight'
    });
    {% endfor %}
  });
</script>
{% endif %}

<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ labels|safe }};
  const data = {{ consumos|safe }};

  const ctx = document.getElementById('consumoChart').getContext('2d');
  const consumoChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Consumo m³',
        data: data,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Consumo mensual (m³)'
        }
      },
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
</script>
<script>
  // Confirmar antes de ir a registrar_pago
  document.querySelectorAll('.btn-pagar').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const url = this.getAttribute('href');
      const anio = this.getAttribute('data-anio');
      const mes = this.getAttribute('data-mes');

      if (confirm(`¿Confirmar pago de ${mes}/${anio} e imprimir recibo?`)) {
        // añadimos un flag para que al volver se auto-imprima
        window.location.href = url + '?print=1';
      }
    });
  });

  // Si la vista indica auto_print y hay lectura_recibo, imprimir al cargar
  {% if auto_print and lectura_recibo %}
  window.addEventListener('load', function() {
    window.print();
  });
  {% endif %}
</script>

<style>  
  .receipt-page {
    width: 210mm;
    height: 135mm;
    padding: 10mm;
    border: 1px solid #000;
    box-sizing: border-box;
    font-size: 11px;
    background: #fff;
  }

  /* HEADER: logo - info - QR */
  .receipt-header {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 5mm;
  }

  .header-left,
  .header-center,
  .header-right {
    flex: 1 1 auto;
  }

  .header-center {
    text-align: center;
  }

  .logo-recibo {
    width: 300px;
    height: auto;
    object-fit: contain;
  }

  /* el QR no suele necesitar mucho estilo extra */
  .header-right img {
    width: 60px;
    height: 60px;
  }

  /* CUERPO: tabla + gráfico */
  .receipt-layout {
    display: flex;
    flex-direction: column;
    height: calc(100% - 40mm); /* resto del alto después del header; ajusta si hace falta */
  }

  .receipt-table-wrapper {
    flex: 1 1 auto;
    max-height: 65mm;      /* límite de alto para la tabla */
    overflow-y: auto;
  }

  .table-recibo th,
  .table-recibo td {
    padding: 2px 4px;
    font-size: 10px;
  }

  .chart-container {
    flex: 0 0 50mm;        /* altura reservada para el gráfico */
  }

  .chart-container canvas {
    width: 35% !important;
    height: auto !important;
  }

  /* PRINT: igual que ya tenías */
  @media print {
    body {
      margin: 0;
      padding: 0;
    }

    @page {
      size: A4 portrait;
      margin: 5mm;
    }

    body * {
      visibility: hidden;
    }

    #recibo, #recibo * {
      visibility: visible;
    }

    #recibo {
      position: absolute;
      left: 0;
      top: 0;
    }

    .no-print {
      display: none !important;
    }
  }

</style>
{% endblock %}
